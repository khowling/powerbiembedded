<html>
<head>
    <meta charset="UTF-8">
    <title>Embedded App</title>
    <meta name="description" content="MixLab">
    <meta name="author" content="Keith Howling">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

</head>
<body>

    <header class="page-header">
        <div class="row">
            <div class="col-md-11 col-md-offset-1">
            <h1>Embedded Dashboard <small>Example of power bi dashboard in bootstrap webpage</small></h1>

            <a id="aadauth" style="display: none;" class="btn btn-primary" href="/login">Authenticate</a>
            <div id="dashdiv" class="form-inline" style="display: none;">
                <label class="mr-sm-2" for="inlineFormInput">Dashboard Name</label>
                <input id="dname" disabled type="text" class="form-control mb-2 mr-sm-2 mb-sm-0"/>
                <a id="aadauth" style="display: none;" class="btn btn-primary">Re-Authenticate</a>
            </div>
            </div>
        </div>
    </header>

    <div class="container-fluid">
        <div class="row">
          <div class="col-xs-12 col-md-10">
              <div class="panel panel-primary"> 
                <div class="panel-heading">Panel heading</div>
                <div class="panel-body" style="padding: 0">
                    <div id="dashboardContainer"></div>
                </div>
            </div>
          </div>
          <div class="col-xs-12 col-md-2">  
            <div class="alert alert-danger" role="alert">
                <a href="#" class="close" data-dismiss="alert">&times;</a>
                <b>Wanring!</b> High Bandwidth Event.<br/><br/> iOS upgrade in next 5hrs! View predicted network <a>impact</a>
            </div>

            <div class="panel panel-primary"> 
                <div class="panel-heading">Panel heading</div>
                <div class="panel-body">
                <img  src="https://upload.wikimedia.org/wikipedia/commons/a/a5/EnglandNorthEast.png"  > 
                <div class="caption"> 
                    <h3>Thumbnail label</h3> 
                    <p>Cras justo odio, dapibus ac facilisis in, egestas eget quam. Donec id elit non mi porta gravida at eget metus.</p> 
                    <p><a class="btn btn-primary" role="button" href="#">Button</a> 
                        <a class="btn btn-default" role="button" href="#">Button</a></p> 
                    </div> 
                </div>
            </div>
            <div class="panel panel-primary"> 
                <div class="panel-heading">Panel heading</div>
                <div class="panel-body">
                    <div class="caption"> 
                        <h3>Thumbnail label</h3> 
                        <p>Cras justo odio, dapibus ac facilisis in, egestas eget quam.</p> 
                        <p>
                            <a class="btn btn-primary" role="button" href="#">Button</a> 
                            <a class="btn btn-default" role="button" href="#">Button</a>
                        </p> 
                    </div> 
                </div>
            </div>        
         </div>
        </div>
    </div>

    <script src="./powerbi.js"></script>
    <script>


    window.onload = function () {

        var client = new XMLHttpRequest();
        var server_url = '/aadauth'
        console.log (server_url)
        client.open('get', server_url)
        client.send()
        //client.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        //client.send(JSON.stringify({"user": "keiht", "secret": "p123"}));
        client.onload = function () {
            if (this.status == 200) {
                // Performs the function "resolve" when this.status is equal to 200
               console.log ('got dashboard ' + this.response)
                let resobj = JSON.parse(this.response)
                if (resobj.embedUrl && resobj.embed_token) {
                    $('#dashdiv').show()
                    $('#did').val(resobj.dashboard_id)
                    $('#dname').val(resobj.displayName)
                    updateEmbedDashboard(resobj.embedUrl, resobj.embed_token,  document.getElementById('dashboardContainer'))
                } else  {
                    $('#aadauth').show()
                }
            } else {
                // Performs the function "reject" when this.status is different than 200
                console.log(this.response);
            }
        }

        client.onerror = function (e) {
            console.log("Network Error: " + this.statusText);
        }

/*
        // client side click to embed a selected dashboard.
        var el = document.getElementById("bEmbedDashboardAction");
        if (el.addEventListener) {
            el.addEventListener("click", updateEmbedDashboard, false);
        } else {
            el.attachEvent('onclick', updateEmbedDashboard);
        }

        // handle server side post backs, optimize for reload scenarios
        // show embedded dashboard if all fields were filled in.
        var accessTokenElement = document.getElementById('MainContent_accessTokenTextbox');
        if (accessTokenElement !== null) {
            var accessToken = accessTokenElement.value;
            if (accessToken !== "")
                updateEmbedDashboard();
        }
*/  
  };

    // update embed dashboard
    function updateEmbedDashboard(embedUrl, accessToken, dashboardContainer) {

        // Embed configuration used to describe the what and how to embed.
        // This object is used when calling powerbi.embed.
        // You can find more information at https://github.com/Microsoft/PowerBI-JavaScript/wiki/Embed-Configuration-Details.
        // Embed the dashboard and display it within the div container.
        var dashboard = powerbi.embed(dashboardContainer, {
            type: 'dashboard',
            accessToken: accessToken,
            embedUrl: embedUrl
        });
/*
        // dashboard.on will add an event handler which prints to Log window.
        dashboard.on("tileClicked", function (event) {
            var logView = document.getElementById('logView');
            logView.innerHTML = logView.innerHTML + "Tile Clicked<br/>";
            logView.innerHTML = logView.innerHTML + JSON.stringify(event.detail, null, "  ") + "<br/>";
            logView.innerHTML = logView.innerHTML + "---------<br/>";
        });

        // dashboard.on will add an event handler which prints to Log window.
        dashboard.on("error", function (event) {
            var logView = document.getElementById('logView');
            logView.innerHTML = logView.innerHTML + "Error<br/>";
            logView.innerHTML = logView.innerHTML + JSON.stringify(event.detail, null, "  ") + "<br/>";
            logView.innerHTML = logView.innerHTML + "---------<br/>";
        });
*/ 
   }
    </script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</body>
</html>